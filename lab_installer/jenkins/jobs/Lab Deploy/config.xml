<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@1546.v62a_c59c112dd">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@2.2265.v140e610fe9d5"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@2.2265.v140e610fe9d5">
      <jobProperties/>
      <triggers/>
      <parameters/>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <com.sonyericsson.rebuild.RebuildSettings plugin="rebuild@338.va_0a_b_50e29397">
      <autoRebuild>false</autoRebuild>
      <rebuildDisabled>false</rebuildDisabled>
    </com.sonyericsson.rebuild.RebuildSettings>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>-1</daysToKeep>
        <numToKeep>50</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
        <removeLastBuild>false</removeLastBuild>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>PROJECT_NAME</name>
          <description>Имя проекта для сборки</description>
          <defaultValue>lab_test</defaultValue>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>DEPLOY_CONTAINERS</name>
          <description>Развертывание Nginx и Tomcat</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>DEPLOY_NGINX_CONF</name>
          <description>Отправка конфигурации в nginx</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>BUILD_FRONTEND</name>
          <description>Сборка фронтенда</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>DEPLOY_FRONTEND</name>
          <description>Развертывание фронтенда</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>BUILD_BACKEND</name>
          <description>Сборка бэкенда</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>DEPLOY_BACKEND</name>
          <description>Развертывание бэкенда</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>DEPLOY_DATABASE</name>
          <description>Развертывание таблиц в бд</description>
          <defaultValue>false</defaultValue>
        </hudson.model.BooleanParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@4183.v94b_6fd39da_c1">
    <script>pipeline {
    agent any
    environment {
        PREPARE_CMD = &quot;chmod o-w /workspace/ansible &amp;&amp; cd /workspace/ansible&quot;
        BASE_ANSIBLE_PARAMS = &quot;-i ../inventory/general -i /host_dirs/${params.PROJECT_NAME}/inventory&quot;
        ANSIBLE_EXEC = &quot;/root/.local/bin/ansible&quot;
        ANSIBLE_EXEC_PLAYBOOK = &quot;/root/.local/bin/ansible-playbook&quot;
    }
    stages {
        stage(&apos;Test connection&apos;) {
            steps {
                script {
                      sh &quot;&quot;&quot;
                        ${env.PREPARE_CMD} &amp;&amp; \
                        ${env.ANSIBLE_EXEC} ${env.BASE_ANSIBLE_PARAMS} -m ping deploy
                        &quot;&quot;&quot;
                }
            }
        }
        stage(&apos;Predeploy&apos;) {
            steps {
                script {
                      sh &quot;&quot;&quot;
                        ${env.PREPARE_CMD} &amp;&amp; \
                        ${env.ANSIBLE_EXEC_PLAYBOOK} ${env.BASE_ANSIBLE_PARAMS} predeploy.yml
                        &quot;&quot;&quot;
                }
            }
        }
        stage(&apos;Containers deploy&apos;) {
            when{
                expression { params.DEPLOY_CONTAINERS }
            }
            steps {
                script {
                      sh &quot;&quot;&quot;
                        ${env.PREPARE_CMD} &amp;&amp; \
                        ${env.ANSIBLE_EXEC_PLAYBOOK} ${env.BASE_ANSIBLE_PARAMS} nginx-deploy.yml
                        &quot;&quot;&quot;
                }
                script {
                      sh &quot;&quot;&quot;
                        ${env.PREPARE_CMD} &amp;&amp; \
                        ${env.ANSIBLE_EXEC_PLAYBOOK} ${env.BASE_ANSIBLE_PARAMS} tomcat-deploy.yml
                        &quot;&quot;&quot;
                }
            }
        }
    }
}
</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>